//tag::ref-doc[]
= TensorFlow Processor

A processor that evaluates a machine learning model stored in TensorFlow Protobuf format.

image::src/test/resources/TensorFlowProcessorArcutectureOverview.png[]

The TensorFlow Processor uses a `TensorflowInputConverter` to convert the input data into data format compliant with the
TensorFlow Model used. The input converter converts the input `Messages` into key/value `Map`, where
the Key corresponds to a model input placeholder and the content is `org.tensorflow.DataType` compliant value.
The default converter implementation expects either Map payload or flat json message that can be converted into a Map.

The `TensorflowInputConverter` can be extended and customized. See link::../spring-cloud-starter-stream-processor-twitter-sentiment/src/main/java/org/springframework/cloud/stream/app/twitter/sentiment/processor/TwitterSentimentTensorflowInputConverter.java[TwitterSentimentTensorflowInputConverter.java] for example.

Processor's output uses `TensorflowOutputConverter` to convert the computed `Tensor` result into a serializable
message. The default implementation uses `Tuple` triple.

Custom `TensorflowOutputConverter` can provide more convenient data representations.
See link::../spring-cloud-starter-stream-processor-twitter-sentiment/src/main/java/org/springframework/cloud/stream/app/twitter/sentiment/processor/TwitterSentimentTensorflowOutputConverter.java[TwitterSentimentTensorflowOutputConverter.java].


Following snippet shows how to export any `TensorFlow` model (trained as well) into `ProtocolBuffer` binary format as required by the Processor.
```python
from tensorflow.python.framework.graph_util import convert_variables_to_constants
...
SAVE_DIR = os.path.abspath(os.path.curdir)
minimal_graph = convert_variables_to_constants(sess, sess.graph_def, ['<model output>'])
tf.train.write_graph(minimal_graph, SAVE_DIR, 'my_graph.proto', as_text=False)
tf.train.write_graph(minimal_graph, SAVE_DIR, 'my.txt', as_text=True)
```

== Options

The **$$tensorflow$$** $$processor$$ has the following options:

//tag::configuration-properties[]
$$tensorflow.expression$$:: $$Specifies where to obtain the input data from. When empty defaults to {@link org.springframework.messaging.Message}'s payload.
 To obtain an input from a {@link org.springframework.tuple.Tuple} set:
 'tensorflow.expression=payload.myInTupleName', where myInTupleName is a Tuple key.
 To obtain input date from a message header use:
 'tensorflow.expression=headers[myHeaderName]', where is the name of the header that contains the input data.$$ *($$Expression$$, default: `$$<none>$$`)*
$$tensorflow.mode$$:: $$Specifies how the outbound data is carried and whether the input message is mirrored in the output or discarded.

 The {@link OutputMode#payload} mode (default) stores the output data in the outbound message payload. The
 input message payload is discarded.

 The {@link OutputMode#header} mode stores the output data in message's header under the
 {@link TensorflowProcessorProperties#outputName} name. The the output message payload mirrors the input payload.

 The {@link OutputMode#tuple} mode stores the output data in the payload using a
 {@link org.springframework.tuple.Tuple} structure. The output data is stored under the
 {@link TensorflowProcessorProperties#outputName} key, while the input payload is passed through under the
 {@link TensorflowProcessorConfiguration#ORIGINAL_INPUT_DATA} key.$$ *($$OutputMode$$, default: `$$<none>$$`, possible values: `payload`,`tuple`,`header`)*
$$tensorflow.model-fetch-index$$:: $$Fetched operation (modelFetchName) returns a list of Tensors. The modelFetchIndex specifies which
 Tensor from that list to use as an output.$$ *($$Integer$$, default: `$$0$$`)*
$$tensorflow.model-fetch-name$$:: $$The graph model output. Name of TensorFlow operation to fetch the output Tensors from.$$ *($$String$$, default: `$$<none>$$`)*
$$tensorflow.model-location$$:: $$The location of the Tensorflow model file.$$ *($$Resource$$, default: `$$<none>$$`)*
$$tensorflow.output-name$$:: $$Applicable only for the {@link OutputMode#header} and {@link OutputMode#tuple} modes. Sets the output data key
 either in the outbound Header or Tuple. If empty it defaults to the modelFetchName property.$$ *($$String$$, default: `$$<none>$$`)*
//end::configuration-properties[]

//end::ref-doc[]
== Build

```
$> mvn package
```
